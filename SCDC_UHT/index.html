<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>DRAFT SCDC UHT - State CHAT Data Community Under the Hood Tool</title>
	<link rel="icon" type="image/png" href="images/nvchat_favicon.png"/>
	
	<link rel="stylesheet" href="nvchatstyle.css"/>
    <!--<link rel="stylesheet" href="https://js.arcgis.com/4.2/esri/themes/claro/dijit/claro.css"/>-->
    <link rel="stylesheet" href="https://js.arcgis.com/3.19/esri/css/esri.css"/>
    <link rel="stylesheet" href="https://js.arcgis.com/3.19/dgrid/css/dgrid.css">

  </head>
  
  <body class="claro">
	<div id="navBar">
		<a href="http://www.ndow.org/Nevada_Wildlife/Maps_and_Data/NVCHAT/" target="_blank"><img id="ndowLogo" src="images/state-chat-logo-blue.png" alt="NDOW Logo" title="NDOW Home Page"></a>
		<span id="mainNav">
			<a id="toolsNav">TOOLS</a>
			<a id="glossaryNav">GLOSSARY</a>
			<a href="http://www.ndow.org/Nevada_Wildlife/Maps_and_Data/NVCHAT/FAQs" target="_blank" class="ndowNav">FAQs</a>
		</span>
		<img id="baseMaps" src="images/basemaps.png" alt="Basemaps">
		<a href="http://www.wafwachat.org" target="_blank"><img id="wafwaLogo" src="images/wafwachatlogo.png" alt="WAFWA CHAT Logo" title="Western Association of Fish and Wildlife Agencies' CHAT"></a>
	</div>
	
	<div id="submenuTools" class="subMenu">
		<ul class="listnostyle">
			<li><a id="queryPoint"><img class="toolsIcon" id="qryIcon" src="images/target16.png" alt="Query Point">Query</a></li>
			<li><a id="drawPoints"><img class="toolsIcon" id="pntIcon" src="images/drawpointsm.png" alt="Draw Point(s)">Points</a></li>
			<li><a id="drawLine"><img class="toolsIcon" id="lineIcon" src="images/drawlinesm.png" alt="Draw Line">Line</a></li>
			<li><a id="drawPoly"><img class="toolsIcon" id="polyIcon" src="images/drawpolygonsm.png" alt="Draw Polygon">Polygon</a></li>
			<li><a id="drawCircle"><img class="toolsIcon" id="circleIcon" src="images/drawcirclesm.png" alt="Draw Circle">Circle</a></li>
			<li><a id="drawRect"><img class="toolsIcon" id="rectIcon" src="images/drawrectanglesm.png" alt="Draw Rectangle">Rectangle</a></li>
			<li><a id="drawClear"><img class="toolsIcon" id="clearIcon" src="images/erasersm.png" alt="Clear Drawing">Clear</a></li>
		</ul>
	</div>
	
	<div id="submenuGlossary" class="subMenu">
		<ul>
			<li><b>BLM:</b> United States Bureau of Land Management</li>
			<li><b>CCVI:</b> Climate Change Vulnerability Index as determined by the NNHP</li>
			<li><b>CHAT:</b> Crucial Habitat Assessment Tool</li>
			<li><b>GAP:</b> Gap Analysis Program administered by the USGS</li>
			<li><b>GNIS:</b> Geographic Names Information System maintained by the USGS</li>
			<li><b>LCM:</b> Landscape Condition Model developed by NatureServe (2009)</li>
			<li><b>LIQT:</b> Landscape Integrity Quality Threshold based upon LCM scores that represent at least 80% of PAD Status 1 & 2 areas.</li>
			<li><b>LS Cond:</b> Landscape condition as modeled by the NatureServe Landscape Condition Model</li>
			<li><b>NHD:</b> National Hydrography Dataset maintained by the USGS</li>
			<li><b>NNHP:</b> Nevada Natural Heritage Program</li>
			<li><b>NWI:</b> National Wetlands Inventory maintained by the USFWS</li>
			<li><b>PAD:</b> Protected Areas Database maintained by the USGS</li>
			<li><b>S-Rank:</b> State conservation rank as determined by the NNHP
				<ul id="sranks" class="listnostyle">
					<li><i>S1:</i> Critically Imperilled</li>
					<li><i>S2:</i> Imperilled</li>
					<li><i>S3:</i> Vulnerable</li>
					<li><i>S4:</i> Apparently Secure</li>
					<li><i>S5:</i> Secure</li>
				</ul>
			</li>
			<li><b>SOC:</b> Species of Concern as identified by the Nevada State Wildlife Action Plan (2012)</li>
			<li><b>SERI:</b> Species of Economic and Recreational Importance</li>
			<li><b>SynthMap:</b> Nevada Vegetation Synthesis Map developed by the NNHP (2008)</li>
			<li><b>USFWS:</b> United States Fish & Wildlife Service</li>
			<li><b>USGS:</b> United States Geological Survey</li>
			<li><b>Wet/Rip:</b> Wetland and/or riparian habitat</li>
			<li><b>WGA:</b> Western Governors' Association</li>
			<li><b>WGWC:</b> Western Governors' Wildlife Council</li>
		</ul>
	</div>	
	
	<span id="chartArea">
<!--		<div id="CHATchrt" class="charts"></div>
		<div id="SOCchrt" class="charts"></div>
		<div id="SERIchrt" class="charts"></div>
		<div id="WetRipchrt" class="charts"></div>
		<div id="LSCondchrt" class="charts"></div>-->
        <div id="myTableNode"></div>
	</span>
	
	<div id="legendArea">
		<img id="infoCHAT" src="images/help_black.png" alt="Info">
		<div id="legendCHAT" class="legendDiv">
			<h4 id="legendHeadCHAT">Crucial Habitat Rank</h4>
			<ul class="inlineLegend">
				<li class="legendItem" id="legendCHAT1" style="background-color: #000070">1</li>
				<li class="legendItem" id="legendCHAT2" style="background-color: #002EB5">2</li>
				<li class="legendItem" id="legendCHAT3" style="background-color: #007FE6">3</li>
				<li class="legendItem" id="legendCHAT4" style="background-color: #00DEFF">4</li>
				<li class="legendItem" id="legendCHAT5" style="background-color: #96FAFF">5</li>
				<li class="legendItem" id="legendCHAT6" style="background-color: #DEFFFF">6</li>
			</ul>
			<span class="legendLabels">
				<span>Most Crucial</span>
				<span class="pullRight">Least Crucial</span>
			</span>
			<div id="sliderDivCHAT" class="sliderDiv"><a id="sliderCHAT"></a></div>
			<input type="checkbox" id="toggleCHAT" checked></input>
			<label for="showLayer">Display</label>
		</div>
		
<!--		<div id="legendSOC" class="legendDiv">
			<h4 id="legendHeadSOC">Species of Concern</h4>
			<ul class="inlineLegend">
				<li class="legendItem" id="legendSOC1" style="background-color: #730000">1</li>
				<li class="legendItem" id="legendSOC2" style="background-color: #A80000">2</li>
				<li class="legendItem" id="legendSOC3" style="background-color: #E60000">3</li>
				<li class="legendItem" id="legendSOC4" style="background-color: #FF7F7F">4</li>
				<li class="legendItem" id="legendSOC5" style="background-color: #FFBEBE">5</li>
				<li class="legendItem" id="legendSOC6" style="background-color: #FFDEE0">6</li>
			</ul>
			<span class="legendLabels">
				<span>Most Crucial</span>
				<span class="pullRight">Least Crucial</span>
			</span>
			<div id="sliderDivSOC" class="sliderDiv"><a id="sliderSOC"></a></div>
			<input type="checkbox" id="toggleSOC"></input>
			<label for="showLayer">Display</label>
		</div>-->
		
		<!--<div id="legendSERI" class="legendDiv">
			<h4 id="legendHeadSERI">Species of Economic and Recreational Importance</h4>
			<ul class="inlineLegend">
				<li class="legendItem" id="legendSERI1" style="background-color: #9C6100">1</li>
				<li class="legendItem" id="legendSERI2" style="background-color: #D99800">2</li>
				<li class="legendItem" id="legendSERI3" style="background-color: #FFAA00">3</li>
				<li class="legendItem" id="legendSERI4" style="background-color: #FFD37F">4</li>
				<li class="legendItem" id="legendSERI5" style="background-color: #FFEBAF">5</li>
				<li class="legendItem" id="legendSERI6" style="background-color: #FFF2D4">6</li>
			</ul>
			<span class="legendLabels">
				<span>Most Crucial</span>
				<span class="pullRight">Least Crucial</span>
			</span>
			<div id="sliderDivSERI" class="sliderDiv"><a id="sliderSERI"></a></div>
			<input type="checkbox" id="toggleSERI"></input>
			<label for="showLayer">Display</label>
		</div>-->
		
		<!--<div id="legendWetRip" class="legendDiv">
			<h4 id="legendHeadWetRip">Wetland/Riparian Habitat</h4>
			<ul class="inlineLegend">
				<li class="legendItem" id="legendWetRip1" style="background-color: #4C5C00">1</li>
				<li class="legendItem" id="legendWetRip2" style="background-color: #70A800">2</li>
				<li class="legendItem" id="legendWetRip3" style="background-color: #98E600">3</li>
				<li class="legendItem" id="legendWetRip4" style="background-color: #D1FF73">4</li>
				<li class="legendItem" id="legendWetRip5" style="background-color: #E9FFBE">5</li>
				<li class="legendItem" id="legendWetRip6" style="background-color: #F2FFE0">6</li>
			</ul>
			<span class="legendLabels">
				<span>Most Crucial</span>
				<span class="pullRight">Least Crucial</span>
			</span>
			<div id="sliderDivWetRip" class="sliderDiv"><a id="sliderWetRip"></a></div>
			<input type="checkbox" id="toggleWetRip"></input>
			<label for="showLayer">Display</label>
		</div>-->
		
<!--		<div id="legendLC" class="legendDiv">
			<h4 id="legendHeadLC">Landscape Condition</h4>
			<ul class="inlineLegend">
				<li class="legendItem" id="legendLC1" style="background-color: #CCB500">1</li>
				<li class="legendItem" id="legendLC2" style="background-color: #E6E600">2</li>
				<li class="legendItem" id="legendLC3" style="background-color: #E6E6E6"></li>
				<li class="legendItem" id="legendLC4" style="background-color: #E6E6E6"></li>
				<li class="legendItem" id="legendLC5" style="background-color: #E6E6E6"></li>
				<li class="legendItem" id="legendLC6" style="background-color: #FFFFE8">6</li>
			</ul>
			<span class="legendLabels">
				<span>Most Crucial</span>
				<span class="pullRight">Least Crucial</span>
			</span>
			<div id="sliderDivLC" class="sliderDiv"><a id="sliderLC"></a></div>
			<input type="checkbox" id="toggleLC"></input>
			<label for="showLayer">Display</label>
		</div>-->
	</div>
	
	<div id="baseMapGallery">
		<div class="arrow"></div>
		<table>
			<tr>
				<td><img class="thumbActive" id="bmStreets" src="images/bm_streets.jpg" alt="Streets"></td>
				<td class="thumbLabel">Streets</td>
			</tr>
			<tr>
			<td><img id="bmTopo" src="images/bm_topo.jpg" alt="Topo"></td>
				<td class="thumbLabel">Topographic</td>
			</tr>
			<tr>
				<td><img id="bmSatellite" src="images/bm_satellite.jpg" alt="Imagery"></td>
				<td class="thumbLabel">Imagery</td>
			</tr>
			<tr>
				<td><img id="bmHybrid" src="images/bm_hybrid.png" alt="Labelled Imagery"></td>
				<td class="thumbLabel">Labelled Imagery</td>
			</tr>
			<tr>
				<td><img id="bmGray" src="images/bm_gray.png" alt="Simple Gray"></td>
				<td class="thumbLabel">Simple Gray</td>
			</tr>
		</table>
	</div>

    <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-55453084-1', 'auto');
	  ga('send', 'pageview');
	</script>
    <script src="https://js.arcgis.com/3.19/"></script>
	<script type="text/javascript" src="tooltips.js"></script>
    <script type="text/javascript">
        require([
            "dojo/_base/array",
        "dojo/store/Memory",
        "dgrid/OnDemandGrid",
        "dgrid/Selection",
		"esri/geometry/Point",
        "esri/map",
		"esri/toolbars/draw",
		"esri/dijit/InfoWindow",
		"esri/layers/FeatureLayer",
		"esri/layers/ArcGISTiledMapServiceLayer",
        "esri/layers/ArcGISDynamicMapServiceLayer",
		"esri/symbols/SimpleMarkerSymbol",
		"esri/symbols/SimpleFillSymbol",
		"esri/symbols/SimpleLineSymbol",
		"esri/symbols/CartographicLineSymbol",
		"esri/tasks/QueryTask",
		"esri/tasks/query",
		"esri/graphic",
        "dojo/_base/declare",
		"dojo/_base/array",
		"dojo/_base/Color",
		"dojo/_base/window",
		"dojo/on",
		"dojo/dom",
		"dojo/dom-construct",
		"dijit/layout/BorderContainer",
		"dijit/layout/AccordionContainer",
		"dijit/form/HorizontalSlider",
		"dijit/layout/ContentPane",
		"dojox/charting/Chart",
		"dojox/charting/plot2d/Bars",
		"dojox/charting/plot2d/Pie",
		"dojox/charting/axis2d/Default",
		"dojox/charting/action2d/Highlight",
		"dojox/charting/action2d/Tooltip",
		"dojox/charting/action2d/MoveSlice",
        "dojox/charting/themes/Tufte",
		"dojo/domReady!"
        ], function(
            array, Memory, Grid, Selection,
		Point,
        Map,
		Draw,
		InfoWindow,
		FeatureLayer,
		ArcGISTiledMapServiceLayer,
        ArcGISDynamicMapServiceLayer,
		SimpleMarkerSymbol,
		SimpleFillSymbol,
		SimpleLineSymbol,
		CartographicLineSymbol,
		QueryTask,
		Query,
		Graphic,
        declare,
		arrayUtils,
		Color,
		win,
		on,
		dom,
		domConstruct,
		BorderContainer,
		AccordionContainer,
		HorizontalSlider,
		ContentPane,
		Chart,
		Bars,
		Pie,
		Default,
		Highlight,
		ChrtTooltip,
		MoveSlice,
        theme
	  ){

            //Create layout widgets for application
            var bcMain = new BorderContainer( {id: "bcMain",design: "sidebar",gutters: false,}, domConstruct.create("div"));
            var cpMap = new ContentPane({ id: "map", region: "center", splitter: "true", style: "border: solid thin silver; overflow: hidden; height:80%;" }, domConstruct.create("div"));
            bcMain.addChild(cpMap);

            var cpMap2 = new ContentPane({ id: "grid", region: "bottom", splitter: "true", style: "border: solid thin silver; overflow: hidden; height:20%;" }, domConstruct.create("div"));
            bcMain.addChild(cpMap2);
		
            document.body.appendChild(bcMain.domNode);
            bcMain.startup();
		
            var infoWindow = new InfoWindow({}, domConstruct.create("div"));//Create infoWindow to replace default popup window, infoWindow is used to allow full customization of chart content
            infoWindow.startup();
            //Create symbol for displaying selected feature
            var selectSymbol = new SimpleFillSymbol( 			SimpleFillSymbol.STYLE_NULL, 			new SimpleLineSymbol(				SimpleLineSymbol.STYLE_SOLID,				new Color("yellow"), 				3),			new Color(null)		);
		
            //Create symbols for displaying user drawn graphics
            var markerSymbol = new SimpleMarkerSymbol(			SimpleMarkerSymbol.STYLE_SQUARE,			10,			new SimpleLineSymbol(				SimpleLineSymbol.STYLE_SOLID,				new Color("black"),				1			),			new Color([255, 0 , 0])		);
		
            var lineSymbol = new CartographicLineSymbol(			CartographicLineSymbol.STYLE_SOLID,			new Color([255, 0, 0]), 			3,			CartographicLineSymbol.CAP_ROUND,			CartographicLineSymbol.JOIN_BEVEL		);
		
            var fillSymbol = new SimpleFillSymbol(			SimpleFillSymbol.STYLE_SOLID,			new SimpleLineSymbol(				SimpleLineSymbol.STYLE_SOLID,				new Color([255, 0, 0]),				2			),			new Color([255, 255, 0, 0.4])		);
		
            //Update chart theme with custom settings
            theme.chart.fill="transparent";
            theme.plotarea.fill="transparent";
            theme.series.font="normal normal bold 8pt Arial";
            theme.series.fontColor="black";	
		
            //Create map
            var map = new Map("map", {			basemap: "streets",			center: [-122, 48],			zoom: 7,			sliderStyle: "large",			sliderPosition: "bottom-right",			infoWindow: infoWindow		});	
		
            ////Tiled map service for CHAT data
            var nvCHAT = new ArcGISDynamicMapServiceLayer("https://www.sciencebase.gov/arcgis/rest/services/Catalog/58b99206e4b090ec658d7e71/MapServer", { opacity: 0.50 } );
            //Tiled map service for SOC data
            var nvSOC = new esri.layers.ArcGISTiledMapServiceLayer("http://gis.ndow.nv.gov/arcgis/rest/services/NVCHAT/SOC_11182014/MapServer", {			opacity: 0		});
            //Tiled map service for SERI data
            var nvSERI = new esri.layers.ArcGISTiledMapServiceLayer("http://gis.ndow.nv.gov/arcgis/rest/services/NVCHAT/SERI_11182014/MapServer", {			opacity: 0		});
            //Tiled map service for Wetland/Riparian data
            var nvWetRip = new esri.layers.ArcGISTiledMapServiceLayer("http://gis.ndow.nv.gov/arcgis/rest/services/NVCHAT/WetRip_11182014/MapServer", {			opacity: 0		});
            //Tiled map service for Landscape Condition data
            var nvLC = new esri.layers.ArcGISTiledMapServiceLayer("http://gis.ndow.nv.gov/arcgis/rest/services/NVCHAT/LC_11182014/MapServer", {			opacity: 0		});
       
            //Feature layer for CHAT data queries
            var nvCHATFL = new esri.layers.FeatureLayer("https://www.sciencebase.gov/arcgis/rest/services/Catalog/55c3e7dce4b033ef52106cc0/MapServer/0", {opacity: 0.20	,
                mode: FeatureLayer.MODE_SELECTION, outFields: ["ch_rank", "hex_id", "ter_soc", "ter_seri", "wet_rip", "ls_cond"],
            });		
            nvCHATFL.setSelectionSymbol(selectSymbol);

            //Feature layer for Nevada extent
            var nvLayer = new esri.layers.FeatureLayer("https://www.sciencebase.gov/arcgis/rest/services/Catalog/55c3e7dce4b033ef52106cc0/MapServer/0", { mode: FeatureLayer.MODE_SNAPSHOT, opacity: 0.2 });
	
            map.addLayers([nvLC, nvWetRip, nvSERI, nvSOC, nvCHAT, nvCHATFL, nvLayer]);
		
            //Set custom mouse cursor when over Nevada data layers
            nvLayer.on("mouse-over", function() {
                if (tbStatus === "off") {
                    map.setMapCursor("url(images/target25.png) 12 12, auto");
                }
            });
		
            nvLayer.on("mouse-out", function() {
                map.setMapCursor("default");
            });
            var sliderCHAT = new HorizontalSlider( {			value: 50,			minimum: 1,			maximum: 100,			intermediateChanges: true,			showButtons: false,			onChange: function(value){				nvCHAT.setOpacity(value/100);			}		}, "sliderCHAT");
	
            //Show/hide layers on legend click event
            document.getElementById("toggleCHAT").onclick = function() {
                layerToggle(nvCHAT, document.getElementById("sliderDivCHAT"));
            }
            //Function to show/hide data layers on legend click event
            function layerToggle(layer, sliderElement) {
                if (layer.opacity > 0) {
                    layer.opacity = 0;
                    sliderElement.style.visibility = "hidden";
                }
                else {
                    layer.opacity = 0.5;
                    sliderElement.style.visibility = "visible";
                }
                layer.refresh();
            }
				
            //Show basemap gallery on click event
            var baseMapButton = document.getElementById("baseMaps");
            var baseMapGallery = document.getElementById("baseMapGallery");
            baseMapButton.onclick = function() {
                if (baseMapGallery.style.visibility != "visible") {
                    baseMapButton.style.background = "#ccbda6";
                    baseMapGallery.style.visibility = "visible";
                }
                else {
                    baseMapButton.style.background = "transparent";
                    baseMapGallery.style.visibility = "hidden";
                }
            }
		
            //Change base map on click event		
            document.getElementById("bmStreets").onclick = function() {
                changeBM(bmStreets = document.getElementById("bmStreets"), "streets");
            }
            document.getElementById("bmTopo").onclick = function() {
                changeBM(bmStreets = document.getElementById("bmTopo"), "topo");
            }
            document.getElementById("bmSatellite").onclick = function() {
                changeBM(bmStreets = document.getElementById("bmSatellite"), "satellite");
            }
            document.getElementById("bmHybrid").onclick = function() {
                changeBM(bmStreets = document.getElementById("bmHybrid"), "hybrid");
            }
            document.getElementById("bmGray").onclick = function() {
                changeBM(bmStreets = document.getElementById("bmGray"), "gray");
            }
		
            //Function to change basemap using custom basemap gallery
            function changeBM(bmElement, bmNew) {
                document.getElementById("bmStreets").className = "";
                document.getElementById("bmTopo").className = "";
                document.getElementById("bmSatellite").className = "";
                document.getElementById("bmHybrid").className = "";
                document.getElementById("bmGray").className = "";
			
                bmElement.className = "thumbActive";
                map.setBasemap(bmNew);
            }
				
            //Initialize draw/query tools
            var tb = new Draw(map);
            tb.deactivate();
            var tbStatus = "off";
		
            //Show/hide draw and query tools on click event
            var submenuTools = document.getElementById("submenuTools");
            document.getElementById("toolsNav").onclick = function() {
                if (submenuTools.style.visibility == "visible") {
                    submenuTools.style.visibility = "hidden";
                    toolsNav.className = "";
                    tb.deactivate();
                    tbStatus = "off";
                }
                else {
                    submenuTools.style.visibility = "visible";
                    toolsNav.className = "active";
                }
            }
		
            //Activate draw/query tool on click event		
            document.getElementById("queryPoint").onclick = function() {
                tb.deactivate();
                map.enableMapNavigation();
                tbStatus = "off";
                nvCHATFL.clearSelection();
            }
            document.getElementById("drawPoints").onclick = function() {
                drawQuery("multipoint");
            }		
            document.getElementById("drawLine").onclick = function() {
                drawQuery("polyline");
            }		
            document.getElementById("drawPoly").onclick = function() {
                drawQuery("polygon");
            }		
            document.getElementById("drawCircle").onclick = function() {
                drawQuery("circle");
            }		
            document.getElementById("drawRect").onclick = function() {
                drawQuery("rectangle");
            }
            document.getElementById("drawClear").onclick = function() {
                tb.deactivate();
                map.enableMapNavigation();
                map.graphics.clear();
                tbStatus = "off";
                nvCHATFL.clearSelection();
                clearCharts();
            }
		
            //Show glossary on mouse over event
            var submenuGlossary = document.getElementById("submenuGlossary");
            document.getElementById("glossaryNav").onmouseover = function() {
                submenuGlossary.style.visibility = "visible";
            }
		
            //Hide glossary on mouse out event
            document.getElementById("glossaryNav").onmouseout = function() {
                submenuGlossary.style.visibility = "hidden";
            }
		
            //Query CHAT data on single map click event		
            map.on("click", function(evt) {
                if (tbStatus === "off") {
                    nvCHATFL.clearSelection();
				
                    var scale = map.getScale();
                    //var minMapScale = nvCHAT.minScale;
                    var minMapScale = 11111111111111111111 //temporarily a high number to get some values

                    //Respond if map scale is too large to display CHAT data
                    if (scale > minMapScale) {
                        map.infoWindow.resize(300, 55);
                        map.infoWindow.setTitle("<b>Data Not Available At This Scale</b>");
                        map.infoWindow.setContent("Zoom in to select data.");
                        map.infoWindow.show(evt.mapPoint);	
                    }
                        //Respond if map scale displays CHAT data
                    else {
                        var qCHAT = new Query();
                        qCHAT.geometry = evt.mapPoint;					
                        map.infoWindow.resize(305, 205);
                        map.infoWindow.setTitle("<b>Crucial Habitat Assessment</b>");
                        nvCHATFL.selectFeatures(qCHAT, FeatureLayer.SELECTION_NEW, function(results) {						
                            if (results.length > 0) {
                                map.infoWindow.show(evt.mapPoint);
                                //createChart(results);  temporarily disable
                            }
                            else {
                                map.infoWindow.hide()
                            }
                        });
                    }
                }			
            });
		
            //Function to add map graphics, select hexagons, and query data based on drawn area of interest
            function drawQuery(graphicType) {
                if (tbStatus === "off") {
                    nvCHATFL.clearSelection();
                }
                tbStatus = "on";
                map.disableMapNavigation();
                tb.activate(graphicType);
                tb.on("draw-end", function(evtGraph) {
                    map.setMapCursor("wait");
                    tb.deactivate();
				
                    var symbol;
                    switch (evtGraph.geometry.type) {
                        case "multipoint":
                            symbol = markerSymbol;
                            break;
                        case "polyline":
                            symbol = lineSymbol;
                            break;
                        default:
                            symbol = fillSymbol;
                            break;
                    }
				
                    map.graphics.add(new Graphic(evtGraph.geometry, symbol));
				
                    var qCHAT = new Query();
                    qCHAT.geometry = evtGraph.geometry;
				
                    nvCHATFL.selectFeatures(qCHAT, FeatureLayer.SELECTION_ADD);
				
                    nvCHATFL.on("selection-complete", function() {
                        var results = nvCHATFL.getSelectedFeatures();
                        if (results.length > 0 && tbStatus === "on") {
                            Query4Relates(results)
                            //chartMulti(results);
                        }
                        map.setMapCursor("default");
                        map.enableMapNavigation();
                    });
                });
            }	


            function Query4Relates(results) {
                var arrayHexs = [];
                if ((results != null) || (results != undefined)) {
                    if (results.length > 0) {
                        dojo.forEach(results, function (feature) {
                            var attr = feature.attributes;
                            var strhex_id = "n/a";
                            if (attr.hex_id != undefined && attr.hex_id != null) {
                                hex_id = attr.hex_id;
                                arrayHexs.push(hex_id);
                            }
                        });
                    }
                }
                //strWhere = "hex_id in (" + arrayHexs.join() + ")";

                strWhere = "hex_id in (3246, 3247, 3248, 4752, 4753, 4754, 4755)";

                var pQueryTask = new esri.tasks.QueryTask("https://www.sciencebase.gov/arcgis/rest/services/Catalog/55c3e7dce4b033ef52106cc0/MapServer/2");
                var pQuery = new esri.tasks.Query();
                pQuery.outFields = ["hex_id", "occurrencename", "taxonomicclass", "occurtypecrit", "sourcedataset", "sourcegeometry", "lastsourcedate", "lastsourceid", "federallistingstatus", "statelistingstatus", "sgcnindicator", "supplemental", "abundancetype", "abundance"];
                pQuery.returnGeometry = false;
                pQuery.where = strWhere;
                pQueryTask.execute(pQuery, qryNonSpatialResults, err);
            }

            function err(err) {
                varStrErrorMessage = err.message;
            }


            //Zoom to the parcel when the user clicks a row
            function onRowClickHandler(evt) {
                var clickedTaxLotId = event.rows[0].data.PARCELID;
                var selectedTaxLot = arrayUtils.filter(map.graphics.graphics, function (graphic) {
                    return ((graphic.attributes) && graphic.attributes.PARCELID === clickedTaxLotId);
                });
                if ( selectedTaxLot.length ) {
                    map.setExtent(selectedTaxLot[0].geometry.getExtent(), true);
                }
            }

            function qryNonSpatialResults(results) {
                var grid;
                // Create a new constructor by mixing in the components // Allow row selection for the grid
                var myGrid = declare([Grid, Selection]);
                //columns for the grid 
                // create the dgrid

                //columns for the grid 
                var columns = [
                  { 'field': 'hex_id', 'label': 'hex_id' },
                  { 'field': 'occurrencename', 'label': 'occurrencename'},
                { 'field': 'taxonomicclass', 'label': "taxonomicclass" },
                { 'field': 'occurtypecrit', 'label': "occurtypecrit" },
                { 'field': 'sourcedataset', 'label': "sourcedataset" },
                { 'field': 'sourcegeometry', 'label': "sourcegeometry" },
                { 'field': 'lastsourcedate', 'label': "lastsourcedate" },
                { 'field': 'lastsourceid', 'label': "lastsourceid" },
                { 'field': 'federallistingstatus', 'label': "federallistingstatus"},
                { 'field': 'statelistingstatus', 'label': "statelistingstatus"},
                { 'field': 'abundance', 'label': 'abundance' },
                { 'field': 'abundancetype', 'label': 'abundancetype' },
                { 'field': 'supplemental', 'label': 'supplemental' },
                { 'field': 'sgcnindicator', 'label': 'sgcnindicator', width: "30%" }
              ];

              grid = new (declare([Grid, Selection]))({
                  // use Infinity so that all data is available in the grid
                  bufferRows: Infinity,
                  columns: columns
              }, "grid");


              grid.on("dgrid-select", onRowClickHandler);

              var resultFeatures = results.features;



              var data = array.map(resultFeatures, function (feature) {
                  return {
                      // property names used here match those used when creating the dgrid
                      "hex_id": feature.attributes['hex_id'],
                      "occurrencename": feature.attributes['occurrencename'],
                      "taxonomicclass": feature.attributes['taxonomicclass'],
                      "occurtypecrit": feature.attributes['occurtypecrit'],
                      "sourcedataset": feature.attributes['sourcedataset'],
                      "sourcegeometry": feature.attributes['sourcegeometry'],
                      "lastsourcedate": feature.attributes['lastsourcedate'],
                      "lastsourceid": feature.attributes['lastsourceid'],
                      "federallistingstatus": feature.attributes['federallistingstatus'],
                      "statelistingstatus": feature.attributes['statelistingstatus'],
                      "abundance": feature.attributes['abundance'],
                      "abundancetype": feature.attributes['abundancetype'],
                      "supplemental": feature.attributes['abundancetype'],
                      "sgcnindicator": feature.attributes['sgcnindicator']
                  };
              });


              var memStore = new Memory({ data: data });
              grid.set("store", memStore);
              ////display the results in the grid
              grid.refresh();
              ////grid.renderArray(items);
              //grid.renderArray(results);
          }

		//Function to create chart content based on single map click query
          function createChart(features) {
              document.getElementById("chartArea").style.backgroundColor = "rgba(0,0,0,0)";
              document.getElementById("chartArea").style.zIndex = "-10";


			var feature = features[0];
			var attr = feature.attributes;
			var CHAT = attr.CH_Rank;
			var SOC = attr.Ter_SOC;
			var SERI = attr.Ter_SERI;
			var WetRip = attr.Wet_Rip;
			var LSCond = attr.LS_Cond;
			
			var c = domConstruct.create("div", {
				id: "infoWinDiv",
				style: "height: 163px; width: 292px;"
			});
			
			map.infoWindow.setContent(c);
			
			//Create bar chart of CHAT ranks
			var chart = new Chart(c, {
				title: "<b>Crucial Habitat Rank: " + CHAT + "</b>",
				titleFontColor: "#000070",
				titleFont: "normal normal bold 12pt Arial",
				titleGap: 5
			});
			
			chart.setTheme(theme);
			
			chart.addPlot("default", {
				type: Bars,
				gap: 3,
				maxBarSize: 40
			});
			
			chart.addAxis("x", {
				min: 0,
				max: 6,
				labels: [
					{value: 0, text: "Least Crucial"},
					{value: 1, text: ""},
					{value: 2, text: ""},
					{value: 3, text: ""},
					{value: 4, text: ""},
					{value: 5, text: ""},
					{value: 6, text: "Most Crucial"}
				],
				minorTicks: false,
				font: "normal normal bold 8pt Arial"
			});
			
			chart.addAxis("y", {
				vertical: true,
				labels: [
					{value: 1, text: "LS Cond"},
					{value: 2, text: "Wet/Rip"},
					{value: 3, text: "SERI"},
					{value: 4, text: "SOC"}
				],
				font: "normal normal bold 8pt Arial",
				minorTicks: false
			});
			
			chart.addSeries("inputData", [
				{x: 1, y: (7 - LSCond), fill: "#E6E600", tooltip: "Landscape Condition Rank: " + LSCond},
				{x: 2, y: (7 - WetRip), fill: "#70A800", tooltip: "Wetland/Riparian Habitat Rank: " + WetRip},
				{x: 3, y: (7 - SERI), fill: "#D99800", tooltip: "Terrestrial Species of Economic & Recreational Importance Rank: " + SERI},
				{x: 4, y: (7 - SOC), fill: "#A80000", tooltip: "Terrestrial Species of Concern Rank: " + SOC}
			]);
		
			//new Highlight(chart, "default");
			//new ChrtTooltip(chart, "default", {});
			
			chart.render();
		}
		
		//Function to create chart results based on multiple hexagon map query
		function chartMulti(results) {
			map.infoWindow.hide();
			clearCharts();
			
			var hexCnt = results.length;
			
			var CHAT1cnt = 0;
			var CHAT2cnt = 0;
			var CHAT3cnt = 0;
			var CHAT4cnt = 0;
			var CHAT5cnt = 0;
			var CHAT6cnt = 0;
			
			var SOC1cnt = 0;
			var SOC2cnt = 0;
			var SOC3cnt = 0;
			var SOC4cnt = 0;
			var SOC5cnt = 0;
			var SOC6cnt = 0;
			var SOC99cnt = 0;
			
			var SERI1cnt = 0;
			var SERI2cnt = 0;
			var SERI3cnt = 0;
			var SERI4cnt = 0;
			var SERI5cnt = 0;
			var SERI6cnt = 0;
			
			var WetRip1cnt = 0;
			var WetRip2cnt = 0;
			var WetRip3cnt = 0;
			var WetRip4cnt = 0;
			var WetRip5cnt = 0;
			var WetRip6cnt = 0;
			var WetRip99cnt = 0;
			
			var LS1cnt = 0;
			var LS2cnt = 0;
			var LS6cnt = 0;
			
			//Tabulate habitat rank counts for selected features
			results.forEach(function(feature) {
				var attr = feature.attributes;
				var CHAT = attr.CH_Rank;
				var SOC = attr.Ter_SOC;
				var SERI = attr.Ter_SERI;
				var WetRip = attr.Wet_Rip;
				var LSCond = attr.LS_Cond;
				
				switch (CHAT) {
					case 1:
						CHAT1cnt++;
						break;
					case 2:
						CHAT2cnt++;
						break;
					case 3:
						CHAT3cnt++;
						break;
					case 4:
						CHAT4cnt++;
						break;
					case 5:
						CHAT5cnt++;
						break;
					case 6:
						CHAT6cnt++;
						break;
				}
				
				switch (SOC) {
					case 1:
						SOC1cnt++;
						break;
					case 2:
						SOC2cnt++;
						break;
					case 3:
						SOC3cnt++;
						break;
					case 4:
						SOC4cnt++;
						break;
					case 5:
						SOC5cnt++;
						break;
					case 6:
						SOC6cnt++;
						break;
					case 9999:
						SOC99cnt++;
						break;
				}
				
				switch (SERI) {
					case 1:
						SERI1cnt++;
						break;
					case 2:
						SERI2cnt++;
						break;
					case 3:
						SERI3cnt++;
						break;
					case 4:
						SERI4cnt++;
						break;
					case 5:
						SERI5cnt++;
						break;
					case 6:
						SERI6cnt++;
						break;
				}
				
				switch (WetRip) {
					case 1:
						WetRip1cnt++;
						break;
					case 2:
						WetRip2cnt++;
						break;
					case 3:
						WetRip3cnt++;
						break;
					case 4:
						WetRip4cnt++;
						break;
					case 5:
						WetRip5cnt++;
						break;
					case 6:
						WetRip6cnt++;
						break;
					case 9999:
						WetRip99cnt++;
						break;
				}
				
				switch (LSCond) {
					case 1:
						LS1cnt++;
						break;
					case 2:
						LS2cnt++;
						break;
					case 6:
						LS6cnt++;
						break;
				}
			});
			
			//Format chart area
			document.getElementById("chartArea").style.backgroundColor="rgba(255,255,255,0.6)";
			document.getElementById("chartArea").style.zIndex="30";
			
			//Create pie chart of CHAT rank results
			var CHATchart = new Chart(CHATchrt, {
				title: "Overall Crucial Habitat",
				titleFont: "normal normal bold 12pt Arial",
				titleFontColor: "#000070",
				titleGap: 5
			});
			
			CHATchart.setTheme(theme);
			
			CHATchart.addPlot("default", {
				type: Pie,
				labelOffset: -20
			});
			
			CHATchart.addSeries("CHATdata", [
				{y: CHAT2cnt/hexCnt, fill: "#002EB5", tooltip: "<b>CHAT Rank 2</b>: " + CHAT2cnt + " out of " + hexCnt + " hexes."},
				{y: CHAT3cnt/hexCnt, fill: "#007FE6", tooltip: "<b>CHAT Rank 3</b>: " + CHAT3cnt + " out of " + hexCnt + " hexes."},
				{y: CHAT4cnt/hexCnt, fill: "#00DEFF", tooltip: "<b>CHAT Rank 4</b>: " + CHAT4cnt + " out of " + hexCnt + " hexes."},
				{y: CHAT5cnt/hexCnt, fill: "#96FAFF", tooltip: "<b>CHAT Rank 5</b>: " + CHAT5cnt + " out of " + hexCnt + " hexes."},
				{y: CHAT6cnt/hexCnt, fill: "#DEFFFF", tooltip: "<b>CHAT Rank 6</b>: " + CHAT6cnt + " out of " + hexCnt + " hexes."},
				{y: CHAT1cnt/hexCnt, fill: "#000070", tooltip: "<b>CHAT Rank 1</b>: " + CHAT1cnt + " out of " + hexCnt + " hexes."}
			]);
		
			new MoveSlice(CHATchart, "default");
			new Highlight(CHATchart, "default");
			new ChrtTooltip(CHATchart, "default", {});
			
			CHATchart.render();
			
			//Create pie chart of SOC rank results
			var SOCchart = new Chart(SOCchrt, {
				title: "Habitat for Sp. of Concern",
				titleFont: "normal normal bold 12pt Arial",
				titleFontColor: "#730000",
				titleGap: 5
			});
			
			SOCchart.setTheme(theme);
			
			SOCchart.addPlot("default", {
				type: Pie,
				labelOffset: -20,
			});
			
			SOCchart.addSeries("SOCdata", [
				{y: SOC2cnt/hexCnt, fill: "#A80000", tooltip: "<b>SOC Rank 2</b>: " + SOC2cnt + " out of " + hexCnt + " hexes."},
				{y: SOC3cnt/hexCnt, fill: "#E60000", tooltip: "<b>SOC Rank 3</b>: " + SOC3cnt + " out of " + hexCnt + " hexes."},
				{y: SOC4cnt/hexCnt, fill: "#FF7F7F", tooltip: "<b>SOC Rank 4</b>: " + SOC4cnt + " out of " + hexCnt + " hexes."},
				{y: SOC5cnt/hexCnt, fill: "#FFBEBE", tooltip: "<b>SOC Rank 5</b>: " + SOC5cnt + " out of " + hexCnt + " hexes."},
				{y: SOC6cnt/hexCnt, fill: "#FFDEE0", tooltip: "<b>SOC Rank 6</b>: " + SOC6cnt + " out of " + hexCnt + " hexes."},
				{y: SOC99cnt/hexCnt, fill: "#CCCCCC", tooltip: "<b>No SOC Data</b>: " + SOC99cnt + " out of " + hexCnt + " hexes."},
				{y: SOC1cnt/hexCnt, fill: "#730000", tooltip: "<b>SOC Rank 1</b>: " + SOC1cnt + " out of " + hexCnt + " hexes."}
			]);
		
			new MoveSlice(SOCchart, "default");
			new Highlight(SOCchart, "default");
			new ChrtTooltip(SOCchart, "default", {});
			
			SOCchart.render();
			
			//Create pie chart of SERI rank results
			var SERIchart = new Chart(SERIchrt, {
				title: "Habitat for Sp. of Econ./Rec. Importance",
				titleFont: "normal normal bold 12pt Arial",
				titleFontColor: "#9C6100",
				titleGap: 5
			});
			
			SERIchart.setTheme(theme);
			
			SERIchart.addPlot("default", {
				type: Pie,
				labelOffset: -20
			});
			
			SERIchart.addSeries("SERIdata", [
				{y: SERI2cnt/hexCnt, fill: "#D99800", tooltip: "<b>SERI Rank 2</b>: " + SERI2cnt + " out of " + hexCnt + " hexes."},
				{y: SERI3cnt/hexCnt, fill: "#FFAA00", tooltip: "<b>SERI Rank 3</b>: " + SERI3cnt + " out of " + hexCnt + " hexes."},
				{y: SERI4cnt/hexCnt, fill: "#FFD37F", tooltip: "<b>SERI Rank 4</b>: " + SERI4cnt + " out of " + hexCnt + " hexes."},
				{y: SERI5cnt/hexCnt, fill: "#FFEBAF", tooltip: "<b>SERI Rank 5</b>: " + SERI5cnt + " out of " + hexCnt + " hexes."},
				{y: SERI6cnt/hexCnt, fill: "#FFF2D4", tooltip: "<b>SERI Rank 6</b>: " + SERI6cnt + " out of " + hexCnt + " hexes."},
				{y: SERI1cnt/hexCnt, fill: "#9C6100", tooltip: "<b>SERI Rank 1</b>: " + SERI1cnt + " out of " + hexCnt + " hexes."}
			]);
		
			new MoveSlice(SERIchart, "default");
			new Highlight(SERIchart, "default");
			new ChrtTooltip(SERIchart, "default", {});
			
			SERIchart.render();
			
			//Create pie chart of Wetland/Riparian rank results
			var WetRipchart = new Chart(WetRipchrt, {
				title: "Wetland/Riparian Habitat",
				titleFont: "normal normal bold 12pt Arial",
				titleFontColor: "#4C5C00",
				titleGap: 5
			});
			
			WetRipchart.setTheme(theme);
			
			WetRipchart.addPlot("default", {
				type: Pie,
				labelOffset: -20
			});
			
			WetRipchart.addSeries("SOCdata", [
				{y: WetRip2cnt/hexCnt, fill: "#70A800", tooltip: "<b>Wetland-Riparian Rank 2</b>: " + WetRip2cnt + " out of " + hexCnt + " hexes."},
				{y: WetRip3cnt/hexCnt, fill: "#98E600", tooltip: "<b>Wetland-Riparian Rank 3</b>: " + WetRip3cnt + " out of " + hexCnt + " hexes."},
				{y: WetRip4cnt/hexCnt, fill: "#D1FF73", tooltip: "<b>Wetland-Riparian Rank 4</b>: " + WetRip4cnt + " out of " + hexCnt + " hexes."},
				{y: WetRip5cnt/hexCnt, fill: "#E9FFBE", tooltip: "<b>Wetland-Riparian Rank 5</b>: " + WetRip5cnt + " out of " + hexCnt + " hexes."},
				{y: WetRip6cnt/hexCnt, fill: "#F2FFE0", tooltip: "<b>Wetland-Riparian Rank 6</b>: " + WetRip6cnt + " out of " + hexCnt + " hexes."},
				{y: WetRip99cnt/hexCnt, fill: "#CCCCCC", tooltip: "<b>No Wetland-Riparian Data</b>: " + WetRip99cnt + " out of " + hexCnt + " hexes."},
				{y: WetRip1cnt/hexCnt, fill: "#4C5C00", tooltip: "<b>Wetland-Riparian Rank 1</b>: " + WetRip1cnt + " out of " + hexCnt + " hexes."}
			]);
		
			new MoveSlice(WetRipchart, "default");
			new Highlight(WetRipchart, "default");
			new ChrtTooltip(WetRipchart, "default", {});
			
			WetRipchart.render();
			
			//Create pie chart of LS Condition rank results
			var LSchart = new Chart(LSCondchrt, {
				title: "Landscape Condition",
				titleFont: "normal normal bold 12pt Arial",
				titleFontColor: "#CCB500",
				titleGap: 5
			});
			
			LSchart.setTheme(theme);
			
			LSchart.addPlot("default", {
				type: Pie,
				labelOffset: -20
			});
			
			LSchart.addSeries("LSdata", [
				{y: LS2cnt/hexCnt, fill: "#E6E600", tooltip: "<b>SOC Rank 2</b>: " + LS2cnt + " out of " + hexCnt + " hexes."},
				{y: LS6cnt/hexCnt, fill: "#FFFF00", tooltip: "<b>SOC Rank 6</b>: " + LS6cnt + " out of " + hexCnt + " hexes."},
				{y: LS1cnt/hexCnt, fill: "#CCB500", tooltip: "<b>SOC Rank 1</b>: " + LS1cnt + " out of " + hexCnt + " hexes."}
			]);
		
			new MoveSlice(LSchart, "default");
			new Highlight(LSchart, "default");
			new ChrtTooltip(LSchart, "default", {});
			
			LSchart.render();			
		}
		
		//Function to clear existing chart data if any
		function clearCharts() {
			document.getElementById("chartArea").style.backgroundColor="rgba(0,0,0,0)";
			document.getElementById("chartArea").style.zIndex="-10";
		
			var div = document.getElementById("CHATchrt");
			while(div.firstChild) {
				div.removeChild(div.firstChild);
			}
			var div = document.getElementById("SOCchrt");
			while(div.firstChild) {
				div.removeChild(div.firstChild);
			}
			var div = document.getElementById("SERIchrt");
			while(div.firstChild) {
				div.removeChild(div.firstChild);
			}
			var div = document.getElementById("WetRipchrt");
			while(div.firstChild) {
				div.removeChild(div.firstChild);
			}
			var div = document.getElementById("LSCondchrt");
			while(div.firstChild) {
				div.removeChild(div.firstChild);
			}
		}
      });
    </script>
  </body>
</html>